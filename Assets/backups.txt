using MySql.Data.MySqlClient;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace AttendancesServices
{
    sealed class MachineAttendance : CommonQueries, IDisposable //,  // : IDisposable
    {

        // private readonly DateTime localDate = new DateTime(2021, 1, 14, 0, 0, 0);  //DateTime.Now;
        // private readonly DateTime localMonthDate = new DateTime(2021, 1, 10, 0, 0, 0); //DateTime.Now.AddMonths(-2);
        private DateTime localDate;
        private DateTime localMonthDate;

        private MySqlConnection conn;
        private Dictionary<string, Dictionary<string, Dictionary<string, string>>> DictData;

        public MachineAttendance(DateTime From, DateTime To)
        {
            localDate = To;
            localMonthDate = From;

            conn = DatabaseConnection.GetDBConnection();
            conn.Open();

            var temp = conn.State.ToString();
            if (temp == "Open")//sqlCon.State == ConnectionState.Open && 
            {
                Console.WriteLine("Machine Connection working.");
            }
            else
            {
                Console.WriteLine("Machine Please check connection string.");
            }
            DictData = new Dictionary<string, Dictionary<string, Dictionary<string, string>>>();
            Console.WriteLine(".............................In Machine Attendance..........................");
        }
        /*public MachineAttendance(string color) : this()
        {
            this.color = color;
            Console.WriteLine("Constructor with color parameter called!");
        }
        public MachineAttendance(string param1, string param2) : this(param1)
        {

        }*/
        public void GetMachineAttendance()
        {
            Console.WriteLine("  Local Date: {0}", localDate);
            Console.WriteLine("  Local Two Month Date: {0}", localMonthDate);

            DataSet attendanceDS = GetAttendanceEmployeeUsers();
            var actual_shifttime_ends_next = new Dictionary<string, DateTime>();
            // Dictionary<string, DateTime> actual_shifttime_ends_prev;// = new Dictionary<string, DateTime>();  //string.Empty;
            // Dictionary<string, string> shiftTimeDict;

            // var DataAttendanceRow = new Dictionary<string, Dictionary<string, Attendance>>();

           
            DateTime checkOlder = new DateTime(2015, 12, 31);
            Dictionary<string, string> employeeUserDict = new Dictionary<string, string>();
            foreach (DataRow campaignRow in attendanceDS.Tables["Attendance"].Rows)//campaignDS.Tables["Customers"].Rows
            {
                // CultureInfo culture = new CultureInfo("en-US");
                // DateTime tempDate = Convert.ToDateTime("1/1/2010 12:10:15 PM", culture);


                DateTime CardTime = Convert.ToDateTime(campaignRow["CardTime"]);
                string NewDate = Convert.ToDateTime(campaignRow["CardTime"]).ToString("yyyy-MM-dd");
                string NextDate = Convert.ToDateTime(campaignRow["CardTime"]).AddDays(1).ToString("yyyy-MM-dd");  // Carbon::parse($value['CardTime'])->addDay()->toDateString();
                string PastDate = Convert.ToDateTime(campaignRow["CardTime"]).AddDays(-1).ToString("yyyy-MM-dd");  // Carbon::parse($value['CardTime'])->subDay()->toDateString();
                string NewTime = Convert.ToDateTime(campaignRow["CardTime"]).ToString("HH:mm:ss");  // Carbon::parse($value['CardTime'])->toTimeString();
                string sap_code = campaignRow["EmployeeCode"].ToString();

                if (DictData.ContainsKey(sap_code))
                {
                    if (!DictData[sap_code].ContainsKey(NewDate))
                    {
                        //    DictData[sap_code][NewDate]["sap_code"] = sap_code;
                        // }
                        // else
                        // {
                        DictData[sap_code].Add(NewDate, new Dictionary<string, string>()); //{ { "sap_code", sap_code } }
                    }
                }
                else
                {
                    DictData.Add(sap_code, new Dictionary<string, Dictionary<string, string>>() { { NewDate, new Dictionary<string, string>() } }); // { { "sap_code", sap_code } }
                }
                if (DictData.ContainsKey(sap_code))
                {
                    if (!DictData[sap_code].ContainsKey(NextDate))
                    {
                        //    DictData[sap_code][NewDate]["sap_code"] = sap_code;
                        //}
                        //else
                        //{
                        DictData[sap_code].Add(NextDate, new Dictionary<string, string>()); //{ { "sap_code", sap_code } }
                    }
                }
                else
                {
                    DictData.Add(sap_code, new Dictionary<string, Dictionary<string, string>>() { { NextDate, new Dictionary<string, string>() } }); // { { "sap_code", sap_code } }
                }

                if (!DictData[sap_code][NewDate].ContainsKey("asm_id"))
                {
                    employeeUserDict = GetUserEmployee(sap_code); //NewDate,
                    if (employeeUserDict.Count() < 1)
                    {
                        continue;
                    }
                }
                //else { 
                // Dictionary<string, string> employeeUserDict = GetUserEmployee(NewDate, sap_code);
                /*if (employeeUserDict.Count() < 1)
                {
                    continue;
                }
                else
                {
                */
                DictData[sap_code][NextDate]["name"] = DictData[sap_code][NewDate]["name"] = employeeUserDict["name"];
                DictData[sap_code][NextDate]["employee_id"] = DictData[sap_code][NewDate]["employee_id"] = employeeUserDict["employee_id"];
                DictData[sap_code][NextDate]["asm_id"] = DictData[sap_code][NewDate]["asm_id"] = employeeUserDict["asm_id"];
                DictData[sap_code][NextDate]["weeklyOff"] = DictData[sap_code][NewDate]["weeklyOff"] = employeeUserDict["weeklyOff"];
                DictData[sap_code][NextDate]["working_hour"] = DictData[sap_code][NewDate]["working_hour"] = employeeUserDict["working_hour"];
                DictData[sap_code][NextDate]["working_hour_number"] = DictData[sap_code][NewDate]["working_hour_number"] = employeeUserDict["working_hour_number"];
                //}
                //string asm_id = employeeUserDict["asm_id"];
                
                Dictionary<string, string> shiftDict = GetAttendanceShift(NewDate, DictData[sap_code][NewDate]["asm_id"]);

                DictData[sap_code][NextDate]["Shifttime"] = DictData[sap_code][NewDate]["Shifttime"] = shiftDict["Shifttime"].ToString();
                DictData[sap_code][NextDate]["Shifttimefound"] = DictData[sap_code][NewDate]["Shifttimefound"] = shiftDict["Shifttimefound"].ToString();
                DictData[sap_code][NextDate]["Shifttimenumber"] = DictData[sap_code][NewDate]["Shifttimenumber"] = shiftDict["Shifttimenumber"].ToString();


                if (!actual_shifttime_ends_next.ContainsKey(sap_code))
                {
                    actual_shifttime_ends_next.Add(sap_code, checkOlder); //{ { "sap_code", sap_code } }
                }
                if (!DictData[sap_code][NewDate].ContainsKey("Intimefound"))
                {
                    DictData[sap_code][NewDate]["Intime"] = string.Empty;
                    DictData[sap_code][NewDate]["InDatetime"] = string.Empty;
                    DictData[sap_code][NewDate]["Intimefound"] = string.Empty;
                }
                if (!DictData[sap_code][NewDate].ContainsKey("Outtimefound"))
                {
                    DictData[sap_code][NewDate]["Outtimefound"] = string.Empty;
                    DictData[sap_code][NewDate]["Outtime"] = string.Empty;
                    DictData[sap_code][NewDate]["OutDatetime"] = string.Empty;
                }
                // Console.Write(DictData);
                // DictData[sap_code][NewDate].Add("sap_code", sap_code);
                // DictData[sap_code][NewDate]["date"] = NewDate;         

                String actual_shifttime = DictData[sap_code][NewDate]["ShiftDatetime"] = Convert.ToDateTime(NewDate + " " + shiftDict["Shifttime"]).ToString("yyyy-MM-dd HH:mm:ss");
                String actual_shifttime_start = DictData[sap_code][NewDate]["ShiftStart"] = Convert.ToDateTime(NewDate + " " + shiftDict["Shifttime"]).AddHours(-4).ToString("yyyy-MM-dd HH:mm:ss");
                String actual_shifttime_ends = DictData[sap_code][NewDate]["ShiftEnd"] = Convert.ToDateTime(NewDate + " " + shiftDict["Shifttime"]).AddHours(20).ToString("yyyy-MM-dd HH:mm:ss");
                String actual_shifttime_start_max = Convert.ToDateTime(NewDate + " " + shiftDict["Shifttime"]).AddHours(6).ToString("yyyy-MM-dd HH:mm:ss");
                DateTime actual_shifttime_margin = Convert.ToDateTime(NewDate + " " + shiftDict["Shifttime"]).AddMinutes(15);
                
                // Console.Write(" {0}\n", shiftDict["Shifttime"]);
                // String.IsNullOrEmpty(s);
                // DateTime.Compare();
                /*
                 * < 0 − If date1 is earlier than date2. date1 before date2
                0 − If date1 is the same as date2. date1 equals date2
                > 0 − If date1 is later than date2. date1 after date2
                */
                int intialCase = DateTime.Compare(actual_shifttime_ends_next[sap_code], checkOlder); // result != 0
                // actual_shifttime_ends_next[sap_code]->notEqualTo(actual_shifttime_ends)
                int resultOut = DateTime.Compare(actual_shifttime_ends_next[sap_code], actual_shifttime_margin); // result != 0
                //actual_shifttime_ends_next["sap_code"]->notEqualTo(actual_shifttime_ends) 
                int resultOut2 = DateTime.Compare(actual_shifttime_ends_next[sap_code], CardTime); // result2 > 0 || date1 > date2
                //$CardTime->lt($actual_shifttime_ends_next) actual_shifttime_ends_next > caredTime
                int resultOut3 = DateTime.Compare(Convert.ToDateTime(actual_shifttime_start), CardTime); // result2 > 0 || date1 > date2 
                // $CardTime->lt($actual_shifttime_start)
                int resultIn = DateTime.Compare(Convert.ToDateTime(actual_shifttime_start), CardTime); // result2 < 0 || date1 < date2
                // $CardTime->gt($actual_shifttime_start);
                int resultIn2 = DateTime.Compare(Convert.ToDateTime(actual_shifttime_start_max), CardTime); // resultIn2 > 0 || date1 > date2
                // $CardTime->lt($actual_shifttime_start_max);
                int resultOut4 = DateTime.Compare(Convert.ToDateTime(actual_shifttime_ends), CardTime); // resultOut4 > 0 || date1 > date2
                // $CardTime->lt($actual_shifttime_ends)
                int resultIn3 = DateTime.Compare(Convert.ToDateTime(actual_shifttime_ends), CardTime); // resultIn3 > 0 || date1 > date2
                                                                                                       //$CardTime->gt($actual_shifttime_ends)

                /*Console.Write(" {0}\n", actual_shifttime_ends_next[sap_code]);
                Console.Write(" {0}\n", checkOlder);
                Console.Write(" {0}\n", intialCase);

                Console.Write(" {0}\n", actual_shifttime_ends_next[sap_code]);
                Console.Write(" {0}\n", actual_shifttime_margin);
                Console.Write(" {0}\n", resultOut);

                Console.Write(" {0}\n", actual_shifttime_ends_next[sap_code]);
                Console.Write(" {0}\n", CardTime);
                Console.Write(" {0}\n", resultOut2);

                Console.Write(" {0}\n", actual_shifttime_start);
                Console.Write(" {0}\n", CardTime);
                Console.Write(" {0}\n", resultOut3);

                Console.Write(" {0}\n", actual_shifttime_start);
                Console.Write(" {0}\n", CardTime);
                Console.Write(" {0}\n", resultIn);

                Console.Write(" {0}\n", actual_shifttime_start_max);
                Console.Write(" {0}\n", CardTime);
                Console.Write(" {0}\n", resultIn2);

                Console.Write(" {0}\n", actual_shifttime_ends);
                Console.Write(" {0}\n", CardTime);
                Console.Write(" {0}\n", resultOut4);

                Console.Write(" {0}\n", actual_shifttime_ends);
                Console.Write(" {0}\n", CardTime);
                Console.Write(" {0}\n", resultIn3);*/

                TimeSpan ReslShift = TimeSpan.Parse("00:00");
                TimeSpan ReslShift2 = TimeSpan.Parse("-06:00");
                if (DictData[sap_code].ContainsKey(PastDate))
                {
                    if (DictData[sap_code][PastDate].ContainsKey("Shifttime"))
                    {
                        TimeSpan PastShift = TimeSpan.Parse(DictData[sap_code][PastDate]["Shifttime"]);
                        TimeSpan CurrShift = TimeSpan.Parse(DictData[sap_code][NewDate]["Shifttime"]);
                        ReslShift =  CurrShift.Subtract(PastShift);

                        Console.Write(" Shift Difference {0}\n", ReslShift);
                        Console.Write(" Difference Result {0}\n", ReslShift >= ReslShift2);
                        Console.Write(" Difference Result2 {0}\n", ReslShift < ReslShift2);

                    }
                }
                


                if (intialCase != 0 && resultOut != 0 && resultOut2 > 0 && resultOut3 > 0) //((resultOut3 > 0 && ReslShift >= ReslShift2) || (resultOut3 < 0 && ReslShift < ReslShift2)))
                {
                    Console.Write(" {0}\n","First IF");
                    if (!DictData[sap_code].ContainsKey(PastDate))
                    {
                        DictData[sap_code].Add(PastDate, new Dictionary<string, string>()); //{ { "sap_code", sap_code } }
                    }
                    DictData[sap_code][PastDate]["Outtime"] = NewTime;
                    DictData[sap_code][PastDate]["Outtimefound"] = "1";
                    DictData[sap_code][PastDate]["OutDatetime"] = Convert.ToDateTime(campaignRow["CardTime"]).ToString("yyyy-MM-dd HH:mm:ss");

                }
                else if (resultIn < 0 && resultIn2 > 0 && String.IsNullOrEmpty(DictData[sap_code][NewDate]["Intimefound"]))
                {
                    Console.Write(" {0}\n", "Second IF");
                    DictData[sap_code][NewDate]["InDatetime"] = Convert.ToDateTime(campaignRow["CardTime"]).ToString("yyyy-MM-dd HH:mm:ss");
                    DictData[sap_code][NewDate]["Intime"] = NewTime;
                    DictData[sap_code][NewDate]["Intimefound"] = "1";
                }
                else if (resultOut4 > 0 && String.IsNullOrEmpty(DictData[sap_code][NewDate]["Outtimefound"]))
                {
                    Console.Write(" {0}\n", "Third IF");
                    DictData[sap_code][NewDate]["Outtime"] = NewTime;
                    DictData[sap_code][NewDate]["Outtimefound"] = "1";
                    DictData[sap_code][NewDate]["OutDatetime"] = Convert.ToDateTime(campaignRow["CardTime"]).ToString("yyyy-MM-dd HH:mm:ss");
                }
                else if (resultIn3 < 0)
                {
                    Console.Write(" {0}\n", "Fourth IF");
                    DictData[sap_code][NextDate]["Intime"] = NewTime; //$all_dates[$NewDate]['Outtime'].'-'.
                    DictData[sap_code][NextDate]["InDatetime"] = Convert.ToDateTime(campaignRow["CardTime"]).ToString("yyyy-MM-dd HH:mm:ss");
                    DictData[sap_code][NextDate]["Intimefound"] = "1";
                }
                else
                {
                    Console.Write(" {0}\n", "Fifth IF");
                    DictData[sap_code][NewDate]["Outtime"] = NewTime; //$all_dates[$NewDate]['Outtime'].'-'.
                    DictData[sap_code][NewDate]["OutDatetime"] = Convert.ToDateTime(campaignRow["CardTime"]).ToString("yyyy-MM-dd HH:mm:ss");
                    // $actual_shifttime_ends_prev = Carbon::parse($NewDate.' '.$shift_time)->addHours(18);
                }
                actual_shifttime_ends_next[sap_code] = Convert.ToDateTime(actual_shifttime_ends);




            }
            foreach (var item in DictData)
            {
                // foo(item.Key);
                // bar(item.Value);
                foreach (var itemL2 in item.Value.ToList())
                {
                    // itemL2.Key;
                    Dictionary<string, string> dictInner = itemL2.Value;
                    if (!dictInner.ContainsKey("asm_id"))
                    {
                        DictData[item.Key].Remove(itemL2.Key);
                        continue;
                    }
                    // Console.Write(dictInner["asm_id"]);
                    DateTime todayDate = Convert.ToDateTime(itemL2.Key);
                    if (!dictInner.ContainsKey("Outtimefound"))
                    {
                        dictInner["Outtimefound"] = string.Empty;
                    }
                    if (!dictInner.ContainsKey("Intimefound"))
                    {
                        dictInner["Intimefound"] = string.Empty;
                    }
                    DictData[item.Key][itemL2.Key]["latearrival"] = "0";
                    DictData[item.Key][itemL2.Key]["lesstime"] = "0";
                    DictData[item.Key][itemL2.Key]["missed"] = "0";
                    DictData[item.Key][itemL2.Key]["difference"] = "0";
                    DictData[item.Key][itemL2.Key]["color"] = "#000";
                    
                    if (String.IsNullOrEmpty(dictInner["Intimefound"]) && (!String.IsNullOrEmpty(dictInner["Outtimefound"])))
                    {
                        // $all_dates[$value['date']]['startEditable'] = false;
                        DictData[item.Key][itemL2.Key]["color"] = "#01ff70";
                        DictData[item.Key][itemL2.Key]["title"] = "In: Missing Out: " + dictInner["Outtime"];
                        DictData[item.Key][itemL2.Key]["missed"] = "1";

                        string missingin = GetMissingAttendance(itemL2.Key, dictInner["asm_id"], "In");
                        if (!String.IsNullOrEmpty(missingin))
                        {
                            DictData[item.Key][itemL2.Key]["color"] = "#02bbf0";
                            DictData[item.Key][itemL2.Key]["title"] = "In: " + missingin + " Out: " + dictInner["Outtime"];
                            DictData[item.Key][itemL2.Key]["missed"] = "0";
                            DictData[item.Key][itemL2.Key]["Intime"] = missingin;
                            DictData[item.Key][itemL2.Key]["Intimefound"] = "1";
                            DictData[item.Key][itemL2.Key]["InDatetime"] = Convert.ToDateTime(Convert.ToDateTime(dictInner["ShiftDatetime"]).ToString("yyyy-MM-dd") + " " + missingin).ToString("yyyy-MM-dd HH:mm:ss");
                        }
                    }
                    else if (String.IsNullOrEmpty(dictInner["Outtimefound"]) && !String.IsNullOrEmpty(dictInner["Intimefound"]))
                    {
                        DictData[item.Key][itemL2.Key]["color"] = "#01ff70";
                        DictData[item.Key][itemL2.Key]["title"] = "In: " + dictInner["Intime"] + " Out: Missing";
                        DictData[item.Key][itemL2.Key]["missed"] = "1";

                        string missingout = GetMissingAttendance(itemL2.Key, dictInner["asm_id"], "Out");
                        if (!String.IsNullOrEmpty(missingout))
                        {
                            DictData[item.Key][itemL2.Key]["color"] = "#02bbf0";
                            DictData[item.Key][itemL2.Key]["title"] = "In: " + dictInner["Intime"] + " Out: " + missingout;
                            DictData[item.Key][itemL2.Key]["missed"] = "0";
                            DictData[item.Key][itemL2.Key]["Outtime"] = missingout;
                            DictData[item.Key][itemL2.Key]["Outtimefound"] = "1";
                            DictData[item.Key][itemL2.Key]["OutDatetime"] = Convert.ToDateTime(Convert.ToDateTime(dictInner["ShiftDatetime"]).ToString("yyyy-MM-dd") + " " + missingout).ToString("yyyy-MM-dd HH:mm:ss");
                        }
                    }
                    if (!String.IsNullOrEmpty(dictInner["Outtimefound"]) && !String.IsNullOrEmpty(dictInner["Intimefound"]))
                    {
                        DateTime Margin = Convert.ToDateTime(dictInner["ShiftDatetime"]).AddMinutes(15);

                        DateTime fromtiming = Convert.ToDateTime(dictInner["InDatetime"]);
                        DateTime totiming = Convert.ToDateTime(dictInner["OutDatetime"]);
                        TimeSpan span = totiming.Subtract(fromtiming);
                        TimeSpan span2 = TimeSpan.Parse(dictInner["working_hour"]);
                        int tresult = TimeSpan.Compare(span, span2);

                        int hours = span.Hours;
                        int minutes = span.Minutes;
                        char spliter = ':';
                        string[] multiArray = dictInner["working_hour"].ToString().Split(spliter);//, StringSplitOptions.None
                        // $diftim = $totiming->diffInHours($fromtiming);
                        // $diftim = $totiming->diff($fromtiming)->format('%H:%i:%s');

                        DictData[item.Key][itemL2.Key]["difference"] = hours + ":" + minutes;
                        int resultMargin = DateTime.Compare(fromtiming, Margin);

                        Console.Write(" {0}\n", "-------------------------------------------------------------------");

                        //Console.Write(" {0}\n", DictData[item.Key][itemL2.Key]["Shifttime"]);
                        //Console.Write(" {0}\n", fromtiming);
                        //Console.Write(" {0}\n", Margin);

                        Console.Write(" {0}\n", span);
                        Console.Write(" {0}\n", dictInner["working_hour"]);
                        Console.Write(" {0}\n", tresult);
                        Console.Write(" {0}\n", int.Parse(multiArray[0]));
                        Console.Write(" {0}\n", int.Parse(multiArray[1]));
                        Console.Write(" {0}\n", hours);
                        Console.Write(" {0}\n", minutes);
                        

                        /*
                        < 0 − If fromtiming is earlier than Margin. fromtiming before Margin
                        = 0 − If date1 is the same as date2. date1 equals date2
                        > 0 − If date1 is later than date2. date1 after date2
                        */
                        // if(strtotime($value['InDatetime']) > strtotime($actual_shifttime_margin->toDateTimeString())){
                        Console.Write(" {0}\n", "-------------------------------------------------------------------");
                        if (resultMargin > 0)
                        {
                            DictData[item.Key][itemL2.Key]["color"] = "#0c679b";
                            DictData[item.Key][itemL2.Key]["latearrival"] = "1";
                        }
                        else if (tresult < 1)
                        {
                            // else if (int.Parse(multiArray[0]) < hours || int.Parse(multiArray[1]) < minutes)
                            DictData[item.Key][itemL2.Key]["color"] = "#301ae3";
                            DictData[item.Key][itemL2.Key]["lesstime"] = "1";
                        }
                        else
                        {
                            DictData[item.Key][itemL2.Key]["color"] = "#02bbf0";
                        }
                        if (tresult < 1) //(int.Parse(multiArray[0]) < hours || int.Parse(multiArray[1]) < minutes)
                        {
                            DictData[item.Key][itemL2.Key]["lesstime"] = "1";
                        }

                        // $all_dates[$value['date']]['color'] = '#02bbf0';
                        // 0c679b Carbon::parse($fromtiming)->lt(Carbon::parse($actual_shifttime_margin)

                        DictData[item.Key][itemL2.Key]["title"] = "In:" + dictInner["Intime"] + " Out: " + dictInner["Outtime"];

                        // $all_dates[$value['date']]['startEditable'] = false;
                        // $all_dates2[$value['date']]['title'] = ' Out: '.$value['Outtime'];
                        // $all_dates[$value['date']]['title'] = $diftim.' In:'.$value['Intime'] .' Out: '.$value['Outtime'];
                        // $all_dates[$value['date']]['title'] = Carbon::parse($fromtiming)->gt(Carbon::parse($actual_shifttime_margin)).' In:'.$value['InDatetime'] .' Out: '.$actual_shifttime_margin;
                        // $all_dates[$value['date']]['title'] = $diftim.' In:'.$diftim .' Out: '.$working_hour;
                        // $all_dates[$value['date']]['title'] = Carbon::parse('first saturday of '.$monthYear).'-'.Carbon::parse('first saturday of '.$monthYear)->eq(Carbon::parse($value['Intime']));
                        // 'Out: '.Carbon::parse($value['Outtime'])->weekOfMonth.'-'.Carbon::parse('third saturday of '.$   ->month.'2020').'-'.Carbon::parse('fourth saturday of '.$request->month.'2020');//Carbon::parse($value['Outtime'])->isSaturday();//Carbon::parse($value['Intime'])->weeksInMonth.
                    }
                }
            }

            SetAttendanceData(DictData);
            conn.Close();
            // Console.Write(DictData);
            // string empUsr = selectAttendanceEmployeeUsers();
            // OpenConection();
            // MySqlCommand cmd = new MySqlCommand(empUsr, conn);
            // Create a data reader and Execute the command
            // MySqlDataReader dataReader = cmd.ExecuteReader();

            //Read the data and store them in the list
            // while (dataReader.Read())
            // {
            //    Console.Write(" {0}\n", dataReader["EmployeeCode"]);
            //    Console.Write(" {0}\n", dataReader["CardTime"]);
            //    Console.Write(" {0}\n", dataReader["role_id"]);
            //    Console.Write(" {0}\n", dataReader["login"]);
            //    Console.Write(" {0}\n", dataReader["sap_code"]);
            //    Console.Write(" {0}\n", dataReader["full_name"]);
            //    Console.Write(" {0}\n", dataReader["slug"]);
            //}

            //close Data Reader
            // dataReader.Close();

            //close Connection
            // CloseConnection();

            //return list to be displayed
            // return list;

            /* string contactQry = "select id, phone from contacts where id > " + campaigns["last_run"] + " and company_id = " + campaigns["company_id"] + " and file_id = " + campaigns["file_id"] + " LIMIT " + campaigns["channels"] + " ; ";*/

            /*string attenUsrEmpQry = "SELECT * FROM";
            attenUsrEmpQry += " (SELECT `kqz_employee`.`EmployeeCode`, `kqz_card`.`CardTime` ";
            attenUsrEmpQry += " FROM `kqz_employee`	INNER JOIN `kqz_card` ON `kqz_employee`.`EmployeeID` = `kqz_card`.`EmployeeID` ";
            attenUsrEmpQry += " WHERE `kqz_card`.`CardTime` >= '"+ localMonthDate.ToString("yyyy-MM-dd HH:mm:ss") + "' ";
            attenUsrEmpQry += " AND `kqz_card`.`CardTime` <= '"+ localDate.ToString("yyyy-MM-dd HH:mm:ss") + "'  ";
            attenUsrEmpQry += " ORDER BY `CardTime` ASC ) attend, ";
            attenUsrEmpQry += " ( SELECT `tbl_users`.`role_id`, `tbl_users`.`login`, `tbl_employees`.`sap_code`, `tbl_employees`.`full_name`, `tbl_setups`.`slug` ";
            attenUsrEmpQry += " from tbl_employees ";
            attenUsrEmpQry += " INNER JOIN `tbl_users` ON `tbl_users`.`employee_id` = `tbl_employees`.`id` ";
            attenUsrEmpQry += " INNER JOIN `tbl_setups` ON `tbl_setups`.`id` = `tbl_users`.`role_id` ";
            attenUsrEmpQry += " ) useremp ";
            attenUsrEmpQry += " where (attend.EmployeeCode = useremp.sap_code or attend.EmployeeCode = useremp.login) ";*/


            /* 
             Console.Write(" {0}\n", attenUsrEmpQry);
             DataSet attenUsrEmpDS = new DataSet();
             DataTable attenUsrEmpDT = new DataTable();
             OpenConection();
             //MySqlCommand attenUsrEmpQryCmd = new MySqlCommand(attenUsrEmpQry, conn);

             MySqlDataAdapter attenUsrEmpQryCmdAdapter = new MySqlDataAdapter(attenUsrEmpQry, conn);

             // OpenConection();
             attenUsrEmpQryCmdAdapter.Fill(attenUsrEmpDS, "UserEmployee");
             //attenUsrEmpQryCmdAdapter.Fill(attenUsrEmpDT);
             CloseConnection();

             *//*using (MySqlDataAdapter attenUsrEmpQryCmdAdapter = new MySqlDataAdapter(attenUsrEmpQryCmd))
             {
                 // DataTable dt = new DataTable();
                 OpenConection();
                 attenUsrEmpQryCmdAdapter.Fill(attenUsrEmpDT);
                 CloseConnection();
                 // Do something with results
             }*/

            /*attenUsrEmpDT.Load(attenUsrEmpQryCmd.ExecuteReader());*/
            /*  Console.Write(" {0}\n", attenUsrEmpDS);*/

        }
        private DataSet GetAttendanceEmployeeUsers()
        {
            string attenUsrEmpQry = " SELECT `kqz_employee`.`EmployeeCode`, `kqz_card`.`CardTime` ";
            attenUsrEmpQry += " FROM `kqz_employee`	INNER JOIN `kqz_card` ON `kqz_employee`.`EmployeeID` = `kqz_card`.`EmployeeID` ";
            attenUsrEmpQry += " WHERE `kqz_card`.`CardTime` >= '" + localMonthDate.ToString("yyyy-MM-dd HH:mm:ss") + "' ";
            attenUsrEmpQry += " AND `kqz_card`.`CardTime` <= '" + localDate.ToString("yyyy-MM-dd HH:mm:ss") + "'  ";// AND `kqz_employee`.`EmployeeCode` = '30011105'  AND `kqz_employee`.`EmployeeCode` = '30000061' //  AND `kqz_employee`.`EmployeeCode` = '30000061'
            attenUsrEmpQry += " ORDER BY `EmployeeCode` ASC, `CardTime` ASC";

            Console.Write(" {0}\n", attenUsrEmpQry);
            // DatabaseConnection.getDBConnection();
            
            // MySqlCommand attenUsrEmp = new MySqlCommand(attenUsrEmpQry, conn); 
            DataSet attenUsrEmpDS = new DataSet();
            // DataTable attenUsrEmpDT = new DataTable();
            // MySqlDataReader attenUsrEmpRdr;


            try
            {
                // Way 1
                // MySqlCommand attenUsrEmp = new MySqlCommand(attenUsrEmpQry, conn);
                // attenUsrEmp.CommandType = CommandType.Text;
                // MySqlDataReader attenUsrEmpRdr = attenUsrEmp.ExecuteReader();

                // Way 2
                // MySqlDataAdapter attenUsrEmpDA = new MySqlDataAdapter(attenUsrEmpQry, conn);
                // attenUsrEmpDA.SelectCommand.CommandType = CommandType.Text;
                // attenUsrEmpDA.Fill(attenUsrEmpDS, "Attendance");

                // Way 3
                using (MySqlCommand attenUsrEmp = new MySqlCommand(attenUsrEmpQry, conn))
                {
                    using (MySqlDataAdapter attenUsrEmpDA = new MySqlDataAdapter(attenUsrEmp))
                    {
                        attenUsrEmpDA.SelectCommand.CommandType = CommandType.Text;
                        attenUsrEmpDA.Fill(attenUsrEmpDS, "Attendance");
                    }
                }


            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.GetBaseException().Message);
            }
            /*finally
            {
                conn.Dispose(); // return connection to the pool
            }*/
           // CloseConnection();
            return attenUsrEmpDS;
            // return attenUsrEmpDT;
        }
        
        private Dictionary<string, string> GetAttendanceShift(string dateValue, string asmId)
        {
            // string cardTime = Convert.ToDateTime(dateValue).ToString("yyyy-MM-dd"); 

            string attenShiftQry = "select `times` from `tbl_users_shifts` ";
            attenShiftQry += " where `asm_id` = " + asmId + " and `status` = 1 and date(`dates`) <= '" + dateValue + "' ";
            attenShiftQry += " order by `dates` desc limit 1 ";

            Console.Write(" {0}\n", attenShiftQry);

            //OpenConection();
            string attenShiftSlr = string.Empty;
            Dictionary<string, string> shiftTimeDict = new Dictionary<string, string>();
            using (MySqlCommand attenShiftCmd = new MySqlCommand(attenShiftQry, conn))
            {
                var tsAttendShift = attenShiftCmd.ExecuteScalar();
                if (tsAttendShift != null)
                {
                    attenShiftSlr = tsAttendShift.ToString();
                }
            }
            // Execute the query and obtain the value of the first column of the first row
            //CloseConnection();
            if (string.IsNullOrEmpty(attenShiftSlr))
            {
                shiftTimeDict["Shifttimefound"] = "0";
                shiftTimeDict["Shifttime"] = "09:00:00";
                shiftTimeDict["Shifttimenumber"] = "09";
            }
            else
            {
                shiftTimeDict["Shifttimefound"] = "1";
                shiftTimeDict["Shifttime"] = attenShiftSlr;
                shiftTimeDict["Shifttimenumber"] = attenShiftSlr.Substring(0, 1);
            }
            return shiftTimeDict;

        }
        private String GetMissingAttendance(string dateValue, string asmId, string missing)
        {
            // DateTime cardTime = Convert.ToDateTime(dateValue);

            string attenShiftQry = "select `time` from `tbl_attendances_missings` ";
            attenShiftQry += " where `asm_id` = " + asmId + " and `active` = 1 and `date` = '" + dateValue + "'  and `missing` = '" + missing + "' ";
            attenShiftQry += " ORDER BY created desc limit 1 ";

            Console.Write(" {0}\n", attenShiftQry);

            //OpenConection();
            String attenShiftSlr; 

            using (MySqlCommand attenShiftCmd = new MySqlCommand(attenShiftQry, conn))
            {
                var attenShiftSlr1 = attenShiftCmd.ExecuteScalar();
                attenShiftSlr = (attenShiftSlr1==null)?string.Empty:attenShiftSlr1.ToString();
            }
                // Execute the query and obtain the value of the first column of the first row
                
            // CloseConnection();
            return attenShiftSlr;

            /*Dictionary<string, string> shiftTimeDict = new Dictionary<string, string>();

            if (string.IsNullOrEmpty(attenShiftSlr))
            {
                shiftTimeDict["Shifttimefound"] = "false";
                shiftTimeDict["Shifttime"] = "09:00:00";
                shiftTimeDict["Shifttimenumber"] = "09";
            }
            else
            {
                shiftTimeDict["Shifttimefound"] = "true";
                shiftTimeDict["Shifttime"] = attenShiftSlr;
                shiftTimeDict["Shifttimenumber"] = attenShiftSlr.Substring(0, 1);
            }
            return shiftTimeDict;*/

        }
        private void SetAttendanceData(Dictionary<string, Dictionary<string, Dictionary<string, string>>> attendances)
        {
            // OpenConection();
            // string dt = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
            try
            {

                foreach (var item in attendances)
                {
                    // foo(item.Key);
                    // bar(item.Value);
                    foreach (var itemL2 in item.Value)
                    {

                        Dictionary<string, string> dictInner = itemL2.Value;

                        DateTime todayDate = Convert.ToDateTime(itemL2.Key);
                        // campaignRow["CardTime"])
                        // int resultent = DateTime.Compare(Convert.ToDateTime(localMonthDate.ToString("yyyy-MM-dd")), todayDate);//|| resultent == 0
                        if (!dictInner.ContainsKey("title") || dictInner.Count < 15 || localMonthDate.Date == todayDate.Date)
                        {
                            continue;
                        }
                        // itemL2.Key;
                        // Console.Write(dictInner["asm_id"]);
                        long count = 0;
                        count = AttendanceAsmidAndDateWiseExist(conn, dictInner["asm_id"].ToString(), itemL2.Key, count);
                        
                        dictInner["proc"] = "Service";
                        dictInner["applied"] = "0";
                        dictInner["span"] = "0";
                        dictInner["type"] = "P";
                        dictInner["date"] = itemL2.Key;
                        dictInner["sap_code"] = item.Key;

                        if (count <= 0)
                        {
                            AttendaceInsert(conn, dictInner, count);
                        }
                        else
                        {
                            AttendaceUpdate(conn, dictInner, count);
                        }
                        //string SelectCheck = "select count(*) from tbl_attendances_machine where asm_id = " + dictInner["asm_id"] + " and date = '" + itemL2.Key + "'"; //" and sap_code = " + item.Key +
                        //Console.Write(" {0}\n", SelectCheck);
                        //MySqlCommand SelectCheckCommand = new MySqlCommand(SelectCheck, conn);
                        /*SelectCheckCommand.Parameters.AddWithValue("@asm_id", dictInner["asm_id"]);
                        SelectCheckCommand.Parameters.AddWithValue("@date", "'"+itemL2.Key+"'");
                        SelectCheckCommand.Parameters.AddWithValue("@sap_code", "'" + item.Key + "'");*/
                       /* string InsertUpdateQry = string.Empty;
                        string insertColumns = string.Empty;
                        string insertValues = string.Empty;
                        string updateColumns = " proc = 'Service', applied = 0, span=0, type='P'";

                        /// Int64 count = (Int64)SelectCheckCommand.ExecuteScalar();
                        // SelectCheckCommand.Dispose();
                        if (!string.IsNullOrEmpty(dictInner["employee_id"]))
                        {
                            updateColumns += ", employee_id = '" + dictInner["employee_id"] + "' ";
                            insertColumns += ", employee_id ";
                            insertValues += ", '" + dictInner["employee_id"] + "' ";
                        }
                        if (!string.IsNullOrEmpty(dictInner["title"]))
                        {
                            updateColumns += ", title = '" + dictInner["title"] + "' ";
                            insertColumns += ", title ";
                            insertValues += ", '" + dictInner["title"] + "' ";
                        }
                        if (dictInner.ContainsKey("InDatetime") && !string.IsNullOrEmpty(dictInner["InDatetime"]))
                        {
                            updateColumns += ", InDatetime = '" + dictInner["InDatetime"] + "' ";
                            insertColumns += ", InDatetime ";
                            insertValues += ", '" + dictInner["InDatetime"] + "' ";
                        }
                        if (dictInner.ContainsKey("Intime") && !string.IsNullOrEmpty(dictInner["Intime"]))
                        {
                            updateColumns += ", Intime = '" + dictInner["Intime"] + "' ";
                            insertColumns += ", Intime ";
                            insertValues += ", '" + dictInner["Intime"] + "' ";
                        }
                        if (dictInner.ContainsKey("OutDatetime") && !string.IsNullOrEmpty(dictInner["OutDatetime"]))
                        {
                            updateColumns += ", OutDatetime = '" + dictInner["OutDatetime"] + "' ";
                            insertColumns += ", OutDatetime ";
                            insertValues += ", '" + dictInner["OutDatetime"] + "' ";
                        }
                        if (dictInner.ContainsKey("Outtime") && !string.IsNullOrEmpty(dictInner["Outtime"]))
                        {
                            updateColumns += ", Outtime = '" + dictInner["Outtime"] + "' ";
                            insertColumns += ", Outtime ";
                            insertValues += ", '" + dictInner["Outtime"] + "' ";
                        }
                        if (dictInner.ContainsKey("Shifttime") && !string.IsNullOrEmpty(dictInner["Shifttime"]))
                        {
                            updateColumns += ", shifttime = '" + dictInner["Shifttime"] + "' ";
                            insertColumns += ", shifttime ";
                            insertValues += ", '" + dictInner["Shifttime"] + "' ";
                        }
                        if (dictInner.ContainsKey("lesstime") && !string.IsNullOrEmpty(dictInner["lesstime"]))
                        {
                            updateColumns += ", lesstime = '" + dictInner["lesstime"] + "' ";
                            insertColumns += ", lesstime ";
                            insertValues += ", '" + dictInner["lesstime"] + "' ";
                        }
                        if (dictInner.ContainsKey("latearrival") && !string.IsNullOrEmpty(dictInner["latearrival"]))
                        {
                            updateColumns += ", latearrival = '" + dictInner["latearrival"] + "' ";
                            insertColumns += ", latearrival ";
                            insertValues += ", '" + dictInner["latearrival"] + "' ";
                        }
                        if (dictInner.ContainsKey("missed") && !string.IsNullOrEmpty(dictInner["missed"]))
                        {
                            updateColumns += ", missed = '" + dictInner["missed"] + "' ";
                            insertColumns += ", missed ";
                            insertValues += ", '" + dictInner["missed"] + "' ";
                        }
                        if (dictInner.ContainsKey("color") && !string.IsNullOrEmpty(dictInner["color"]))
                        {
                            updateColumns += ", color = '" + dictInner["color"] + "' ";
                            insertColumns += ", color ";
                            insertValues += ", '" + dictInner["color"] + "' ";
                        }
                        if (dictInner.ContainsKey("Intimefound") && !string.IsNullOrEmpty(dictInner["Intimefound"]))
                        {
                            updateColumns += ", Intimefound = '" + dictInner["Intimefound"] + "' ";
                            insertColumns += ", Intimefound ";
                            insertValues += ", '" + dictInner["Intimefound"] + "' ";
                        }
                        if (dictInner.ContainsKey("Outtimefound") && !string.IsNullOrEmpty(dictInner["Outtimefound"]))
                        {
                            updateColumns += ", Outtimefound = '" + dictInner["Outtimefound"] + "' ";
                            insertColumns += ", Outtimefound ";
                            insertValues += ", '" + dictInner["Outtimefound"] + "' ";
                        }
                        if (dictInner.ContainsKey("Shifttimefound") && !string.IsNullOrEmpty(dictInner["Shifttimefound"]))
                        {
                            updateColumns += ", Shifttimefound = '" + dictInner["Shifttimefound"] + "' ";
                            insertColumns += ", Shifttimefound ";
                            insertValues += ", '" + dictInner["Shifttimefound"] + "' ";
                        }
                        if (dictInner.ContainsKey("ShiftDatetime") && !string.IsNullOrEmpty(dictInner["ShiftDatetime"]))
                        {
                            updateColumns += ", ShiftDatetime = '" + dictInner["ShiftDatetime"] + "' ";
                            insertColumns += ", ShiftDatetime ";
                            insertValues += ", '" + dictInner["ShiftDatetime"] + "' ";
                        }
                        if (dictInner.ContainsKey("ShiftStart") && !string.IsNullOrEmpty(dictInner["ShiftStart"]))
                        {
                            updateColumns += ", ShiftStart = '" + dictInner["ShiftStart"] + "' ";
                            insertColumns += ", ShiftStart ";
                            insertValues += ", '" + dictInner["ShiftStart"] + "' ";
                        }
                        if (dictInner.ContainsKey("ShiftEnd") && !string.IsNullOrEmpty(dictInner["ShiftEnd"]))
                        {
                            updateColumns += ", ShiftEnd = '" + dictInner["ShiftEnd"] + "' ";
                            insertColumns += ", ShiftEnd ";
                            insertValues += ", '" + dictInner["ShiftEnd"] + "' ";
                        }
                        if (dictInner.ContainsKey("difference") && !string.IsNullOrEmpty(dictInner["difference"]))
                        {
                            updateColumns += ", difference = '" + dictInner["difference"] + "' ";
                            insertColumns += ", difference ";
                            insertValues += ", '" + dictInner["difference"] + "' ";
                        }

                        if (count > 0)
                        {
                            InsertUpdateQry = " UPDATE tbl_attendances_machine set " + updateColumns;
                            InsertUpdateQry += " where asm_id = " + dictInner["asm_id"] + " and date = '" + itemL2.Key + "'"; // + " and sap_code = " + item.Key + "";

                        }
                        else
                        {
                            InsertUpdateQry = " INSERT INTO tbl_attendances_machine ( asm_id, date, sap_code " + insertColumns + ", proc, applied, span, type) ";
                            InsertUpdateQry += " values ( " + dictInner["asm_id"] + ", '" + itemL2.Key + "' , " + item.Key + " " + insertValues + ", 'Service', 0, 0, 'P' )";
                            // insertColumns += ", proc ) ";
                            // insertValues += ", 'Service' ) ";
                            // string updateQry = insertColumns + " " + insertValues;
                            *//*
                            if (string.IsNullOrEmpty(dictInner["Intimefound"]))
                            {
                                dictInner["Intimefound"] = "0";
                            }
                            if (string.IsNullOrEmpty(dictInner["Outtimefound"]))
                            {
                                dictInner["Outtimefound"] = "0";
                            }*//*
                        }

                        Console.Write(" {0}\n", InsertUpdateQry);


                        MySqlCommand command = new MySqlCommand(InsertUpdateQry, conn);
                        command.ExecuteNonQuery();
                        *//*if (command.ExecuteNonQuery() != 1)
                        {
                            //'handled as needed, //' but this snippet will throw an exception to force a rollback
                            throw new InvalidProgramException();
                        }*//*
                        command.Dispose();*/
                        // dictInner["Intimefound"] = (string.IsNullOrEmpty(dictInner["Intimefound"])) ? 0 : dictInner["Intimefound"];
                        // Define a query returning a single row result set
                        /*   string updateQry = "INSERT INTO tbl_attendances_machine (asm_id, date, sap_code, title, InDatetime, Intime, OutDatetime, Outtime, shifttime, lesstime, latearrival, missed, color, Intimefound, Outtimefound, Shifttimefound, ShiftDatetime, ShiftStart, ShiftEnd, difference, from )";
                           updateQry += " values (" + dictInner["asm_id"] + ", ";
                           updateQry += itemL2.Key + ", ";
                           updateQry += item.Key + ", '";
                           updateQry += dictInner["title"] + "', ";
                           updateQry += "'"+dictInner["InDatetime"] + "', ";
                           updateQry += "'" + dictInner["Intime"] + "', ";
                           updateQry += "'" + dictInner["OutDatetime"] + "', ";
                           updateQry += "'" + dictInner["Outtime"] + "', ";
                           updateQry += "'" + dictInner["Shifttime"] + "', ";
                           updateQry += dictInner["lesstime"] + ", ";
                           updateQry += dictInner["latearrival"] + ", ";
                           updateQry += dictInner["missed"] + ", '";
                           updateQry += dictInner["color"] + "', ";
                           updateQry += dictInner["Intimefound"] + ", ";
                           updateQry += dictInner["Outtimefound"] + ", ";
                           updateQry += dictInner["Shifttimefound"] + ", ";
                           updateQry += "'" + dictInner["ShiftDatetime"] + "', ";
                           updateQry += "'" + dictInner["ShiftStart"] + "', ";
                           updateQry += "'" + dictInner["ShiftEnd"] + "', '";
                           updateQry += dictInner["difference"] + "', ";
                           updateQry += "'Service')";*/
                        // Execute the query and obtain the value of the first column of the first row
                        //int cnt = command.ExecuteNonQuery();
                        // Console.Write("Saved Rown Campaigns are {0}\n", cnt);
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.GetBaseException().Message);
                // oTransaction.Rollback();
                // throw;
            }
            finally
            {
               
            }
            // Define a query returning a single row result set
            /*string updateQry = "INSERT INTO campaign_dials (asm_id, date, sap_code, title, InDatetime, Intime, OutDatetime, Outtime, shifttime, lesstime, latearrival, missed, color, Intimefound, Outtimefound, Shifttimefound, ShiftDatetime, ShiftStart, ShiftEnd, difference )";
            updateQry += " values (" + insert["campaign_id"] + ", " + insert["file_id"] + ", " + insert["company_id"] + ", '" + insert["phonefrom"] + "', '" + insert["transferto"] + "', '" + insert["ivrAudio"] + "', '" + insert["vmaudio"] + "', '" + insert["campaigntype"] + "', '" + insert["isvmdrop"] + "', '" + insert["dnclistkeypressnumber"] + "', '" + insert["transfertokeypressnumber"] + "', '" + insert["phoneto"] + "', '" + insert["dropid"] + "', '" + insert["uuid"] + "', '" + insert["provider"] + "', " + insert["created_by"] + ", '" + dt + "' )";
            MySqlCommand command = new MySqlCommand(updateQry, conn);
            // Console.Write(" {0}\n", updateQry);
            // Execute the query and obtain the value of the first column of the first row
            int cnt = command.ExecuteNonQuery();
            // Console.Write("Saved Rown Campaigns are {0}\n", cnt);*/
            // CloseConnection();
            // return null;
        }
        public void Dispose()

        {

            // Using the dispose pattern

            // Dispose(true);

            // … release unmanaged resources here

            GC.SuppressFinalize(this);

        }
        ~MachineAttendance()
        {
            DictData = null;
            conn.Close();
            conn.Dispose();
            Console.WriteLine(".............................Out Machine Attendance..........................");
        }

    }
}




private Dictionary<string, string> GetUserEmployeeGazetted(string code)//
        {
            // DateTime cardTime = Convert.ToDateTime(dateValue);
            Dictionary<string, string> employeeUserDict = new Dictionary<string, string>();

            string employyeeUserQry = "SELECT  `tbl_employees`.`id`, `tbl_users`.`role_id`, `tbl_users`.`login`, `tbl_employees`.`sap_code`, `tbl_employees`.`full_name`, `tbl_setups`.`slug` ";
            employyeeUserQry += " from tbl_employees ";
            employyeeUserQry += " INNER JOIN `tbl_users` ON `tbl_users`.`employee_id` = `tbl_employees`.`id` ";
            employyeeUserQry += " INNER JOIN `tbl_setups` ON `tbl_setups`.`id` = `tbl_users`.`role_id` ";
            employyeeUserQry += " where tbl_employees.status = 1 " +
                " and (tbl_employees.sap_code = " + code + " or tbl_users.login = " + code + " )" +
                " ORDER BY tbl_employees.created desc limit 1 ";

            Console.Write(" {0}\n", employyeeUserQry);


            using (MySqlCommand employeeUserCmd = new MySqlCommand(employyeeUserQry, conn))
            {
                employeeUserCmd.CommandType = CommandType.Text;
                using (MySqlDataReader attenUsrEmpRdr = employeeUserCmd.ExecuteReader())
                {
                    if (attenUsrEmpRdr.HasRows)
                    {
                        while (attenUsrEmpRdr.Read())
                        {
                            employeeUserDict["employee_id"] = attenUsrEmpRdr["id"].ToString();
                            employeeUserDict["role_id"] = attenUsrEmpRdr["role_id"].ToString();
                            employeeUserDict["asm_id"] = attenUsrEmpRdr["login"].ToString();
                            employeeUserDict["sap_code"] = attenUsrEmpRdr["sap_code"].ToString();
                            employeeUserDict["slug"] = attenUsrEmpRdr["slug"].ToString();
                            employeeUserDict["full_name"] = attenUsrEmpRdr["full_name"].ToString();

                            String slug = attenUsrEmpRdr["slug"].ToString();
                            if (slug.Contains("ALTER"))
                            {
                                employeeUserDict["weeklyOff"] = "alternative";
                                employeeUserDict["working_hour"] = "08:30";
                                employeeUserDict["working_hour_number"] = "8.5";
                            }
                            else if (slug.Contains("DUAL"))
                            {
                                employeeUserDict["weeklyOff"] = "dual";
                                employeeUserDict["working_hour"] = "09:00";
                                employeeUserDict["working_hour_number"] = "9.0";
                            }
                            else
                            {
                                employeeUserDict["weeklyOff"] = "single";
                                employeeUserDict["working_hour"] = "08:00";
                                employeeUserDict["working_hour_number"] = "8.0";
                            }
                        }
                    }
                    /*else
                    {
                        employeeUserDict["weeklyOff"] = "single";
                        employeeUserDict["working_hour"] = "08:00";
                        employeeUserDict["working_hour_number"] = "8.0";
                    }*/
                }

            }
            // CloseConnection();
            return employeeUserDict;
        }



        private Dictionary<string, string> GetUserEmployeeOffDays(string code)//
        {
            // DateTime cardTime = Convert.ToDateTime(dateValue);
            Dictionary<string, string> employeeUserDict = new Dictionary<string, string>();

            string employyeeUserQry = "SELECT  `tbl_employees`.`id`, `tbl_users`.`role_id`, `tbl_users`.`login`, `tbl_employees`.`sap_code`, `tbl_employees`.`full_name`, `tbl_setups`.`slug` ";
            employyeeUserQry += " from tbl_employees ";
            employyeeUserQry += " INNER JOIN `tbl_users` ON `tbl_users`.`employee_id` = `tbl_employees`.`id` ";
            employyeeUserQry += " INNER JOIN `tbl_setups` ON `tbl_setups`.`id` = `tbl_users`.`role_id` ";
            employyeeUserQry += " where tbl_employees.status = 1 " +
                " and (tbl_employees.sap_code = " + code + " or tbl_users.login = " + code + " )" +
                " ORDER BY tbl_employees.created desc limit 1 ";

            Console.Write(" {0}\n", employyeeUserQry);


            using (MySqlCommand employeeUserCmd = new MySqlCommand(employyeeUserQry, conn))
            {
                employeeUserCmd.CommandType = CommandType.Text;
                using (MySqlDataReader attenUsrEmpRdr = employeeUserCmd.ExecuteReader())
                {
                    if (attenUsrEmpRdr.HasRows)
                    {
                        while (attenUsrEmpRdr.Read())
                        {
                            employeeUserDict["employee_id"] = attenUsrEmpRdr["id"].ToString();
                            employeeUserDict["role_id"] = attenUsrEmpRdr["role_id"].ToString();
                            employeeUserDict["asm_id"] = attenUsrEmpRdr["login"].ToString();
                            employeeUserDict["sap_code"] = attenUsrEmpRdr["sap_code"].ToString();
                            employeeUserDict["slug"] = attenUsrEmpRdr["slug"].ToString();
                            employeeUserDict["full_name"] = attenUsrEmpRdr["full_name"].ToString();

                            String slug = attenUsrEmpRdr["slug"].ToString();
                            if (slug.Contains("ALTER"))
                            {
                                employeeUserDict["weeklyOff"] = "alternative";
                                employeeUserDict["working_hour"] = "08:30";
                                employeeUserDict["working_hour_number"] = "8.5";
                            }
                            else if (slug.Contains("DUAL"))
                            {
                                employeeUserDict["weeklyOff"] = "dual";
                                employeeUserDict["working_hour"] = "09:00";
                                employeeUserDict["working_hour_number"] = "9.0";
                            }
                            else
                            {
                                employeeUserDict["weeklyOff"] = "single";
                                employeeUserDict["working_hour"] = "08:00";
                                employeeUserDict["working_hour_number"] = "8.0";
                            }
                        }
                    }
                    /*else
                    {
                        employeeUserDict["weeklyOff"] = "single";
                        employeeUserDict["working_hour"] = "08:00";
                        employeeUserDict["working_hour_number"] = "8.0";
                    }*/
                }

            }
            // CloseConnection();
            return employeeUserDict;
        }
